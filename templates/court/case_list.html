{% extends 'base.html' %}
{% load static %}

{% block title %}Case Management - {{ user_role|title }}{% endblock %}

{% block page_title %}{% if user_role == 'clerk' %}Case Management{% else %}My Assigned Cases{% endif %}{% endblock %}



{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="bi bi-folder me-2"></i>
            {% if user_role == 'clerk' %}
                Case Management
            {% else %}
                My Assigned Cases
            {% endif %}
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            {% if user_role == 'clerk' %}
                <a href="{% url 'court:case_create' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-2"></i>
                    Create New Case
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchCase" placeholder="Search cases...">
                        <button class="btn btn-outline-secondary" type="button" onclick="searchCases()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="assigned">Assigned</option>
                        <option value="in_progress">In Progress</option>
                        <option value="decided">Decided</option>
                        <option value="closed">Closed</option>
                        <option value="appealed">Appealed</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="typeFilter">
                        <option value="">All Types</option>
                        <option value="criminal">Criminal</option>
                        <option value="civil">Civil</option>
                        <option value="family">Family</option>
                        <option value="commercial">Commercial</option>
                        <option value="administrative">Administrative</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-primary w-100" onclick="filterCases()">
                        <i class="bi bi-funnel me-2"></i>
                        Filter
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cases Table -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Case Number</th>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Judge</th>
                            <th>Filing Date</th>
                            <th>Priority</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for case in cases %}
                        <tr data-status="{{ case.status }}" data-type="{{ case.case_type }}">
                            <td><strong>{{ case.case_number }}</strong></td>
                            <td>
                                <div class="fw-bold">{{ case.title|truncatechars:40 }}</div>
                                <small class="text-muted">{{ case.description|truncatechars:60 }}</small>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ case.get_case_type_display }}</span>
                            </td>
                            <td>
                                {% if case.status == 'pending' %}
                                    <span class="badge bg-warning">{{ case.get_status_display }}</span>
                                {% elif case.status == 'assigned' %}
                                    <span class="badge bg-info">{{ case.get_status_display }}</span>
                                {% elif case.status == 'in_progress' %}
                                    <span class="badge bg-primary">{{ case.get_status_display }}</span>
                                {% elif case.status == 'decided' %}
                                    <span class="badge bg-success">{{ case.get_status_display }}</span>
                                {% elif case.status == 'closed' %}
                                    <span class="badge bg-secondary">{{ case.get_status_display }}</span>
                                {% elif case.status == 'appealed' %}
                                    <span class="badge bg-danger">{{ case.get_status_display }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if case.assigned_judge %}
                                    <div class="d-flex align-items-center">
                                        <div class="bg-primary rounded-circle p-2 me-2">
                                            <i class="bi bi-person text-white"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold">{{ case.assigned_judge.get_full_name }}</div>
                                            <small class="text-muted">{{ case.assigned_judge.username }}</small>
                                        </div>
                                    </div>
                                {% else %}
                                    <span class="text-muted">Not assigned</span>
                                {% endif %}
                            </td>
                            <td>{{ case.filing_date|date:"M d, Y" }}</td>
                            <td>
                                {% if case.priority == 'high' %}
                                    <span class="badge bg-danger">High</span>
                                {% elif case.priority == 'medium' %}
                                    <span class="badge bg-warning">Medium</span>
                                {% else %}
                                    <span class="badge bg-info">Low</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="{% url 'court:case_detail' case.id %}" class="btn btn-outline-primary" title="View">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{% url 'court:case_edit' case.id %}" class="btn btn-outline-secondary" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    {% if not case.assigned_judge %}
                                    <a href="{% url 'court:case_assign' case.id %}" class="btn btn-outline-success" title="Assign Judge">
                                        <i class="bi bi-person-plus"></i>
                                    </a>
                                    {% endif %}
                                    <a href="{% url 'court:evidence_list' case.id %}" class="btn btn-outline-info" title="Evidence">
                                        <i class="bi bi-file-earmark-text"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                <i class="bi bi-folder-x fs-1 d-block mb-2"></i>
                                No cases found
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Case filtering
    function filterCases() {
        const statusFilter = document.getElementById('statusFilter').value;
        const typeFilter = document.getElementById('typeFilter').value;
        const rows = document.querySelectorAll('tbody tr[data-status]');
        
        rows.forEach(row => {
            let show = true;
            
            if (statusFilter && row.dataset.status !== statusFilter) {
                show = false;
            }
            
            if (typeFilter && row.dataset.type !== typeFilter) {
                show = false;
            }
            
            row.style.display = show ? '' : 'none';
        });
    }

    // Search functionality
    function searchCases() {
        const query = document.getElementById('searchCase').value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr[data-status]');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(query) ? '' : 'none';
        });
    }

    // Event listeners
    document.getElementById('statusFilter').addEventListener('change', filterCases);
    document.getElementById('typeFilter').addEventListener('change', filterCases);
    
    document.getElementById('searchCase').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchCases();
        }
    });
</script>
{% endblock %}
