{% extends 'base.html' %}
{% load static %}

{% block title %}Schedule Hearing - Court Clerk{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="bi bi-calendar-plus me-2"></i>
            Schedule Hearing
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{% url 'court:hearing_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>
                Back to Hearings
            </a>
        </div>
    </div>

    <!-- Alert Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <div class="col-lg-8">
            <!-- Hearing Creation Form -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clipboard-plus me-2"></i>
                        Hearing Information
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="case" class="form-label">Case *</label>
                                <select class="form-select" id="case" name="case" required>
                                    <option value="">Select case...</option>
                                    <!-- This will be populated via AJAX -->
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="hearing_type" class="form-label">Hearing Type *</label>
                                <select class="form-select" id="hearing_type" name="hearing_type" required>
                                    <option value="">Select type...</option>
                                    <option value="preliminary">Preliminary Hearing</option>
                                    <option value="trial">Trial</option>
                                    <option value="sentencing">Sentencing</option>
                                    <option value="appeal">Appeal Hearing</option>
                                    <option value="review">Review Hearing</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="scheduled_date" class="form-label">Scheduled Date *</label>
                                <input type="date" class="form-control" id="scheduled_date" name="scheduled_date" required>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="scheduled_time" class="form-label">Scheduled Time *</label>
                                <input type="time" class="form-control" id="scheduled_time" name="scheduled_time" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="duration_minutes" class="form-label">Duration (minutes)</label>
                                <input type="number" class="form-control" id="duration_minutes" name="duration_minutes" 
                                       min="15" max="480" placeholder="60">
                                <div class="form-text">Estimated duration in minutes</div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="location" class="form-label">Location *</label>
                                <input type="text" class="form-control" id="location" name="location" 
                                       placeholder="Courtroom number or location" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="judge" class="form-label">Judge *</label>
                                <select class="form-select" id="judge" name="judge" required>
                                    <option value="">Select judge...</option>
                                    <!-- This will be populated via AJAX -->
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="clerk" class="form-label">Clerk</label>
                                <input type="text" class="form-control" id="clerk" name="clerk" 
                                       value="{{ user.get_full_name }}" readonly>
                                <div class="form-text">Current user will be assigned as clerk</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" 
                                      placeholder="Additional notes about the hearing..."></textarea>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>
                                Schedule Hearing
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Hearing Guidelines -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Hearing Guidelines
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            Check judge availability
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            Ensure courtroom is available
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            Set realistic duration estimates
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            Provide clear location information
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            Include relevant notes
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Hearing Types -->
            <div class="card shadow-sm mt-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-list-ul me-2"></i>
                        Hearing Type Descriptions
                    </h6>
                </div>
                <div class="card-body">
                    <small class="text-muted">
                        <strong>Preliminary:</strong> Initial hearing to determine case validity<br>
                        <strong>Trial:</strong> Main court proceeding to hear evidence<br>
                        <strong>Sentencing:</strong> Hearing to determine punishment<br>
                        <strong>Appeal:</strong> Review of previous decision<br>
                        <strong>Review:</strong> Periodic case status review
                    </small>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card shadow-sm mt-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-lightning me-2"></i>
                        Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'court:hearing_list' %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-list me-2"></i>
                            View All Hearings
                        </a>
                        <a href="{% url 'court:case_list' %}" class="btn btn-outline-info btn-sm">
                            <i class="bi bi-folder me-2"></i>
                            View All Cases
                        </a>
                        <a href="{% url 'court:case_create' %}" class="btn btn-outline-warning btn-sm">
                            <i class="bi bi-plus-circle me-2"></i>
                            Create New Case
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Load cases and judges when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadCases();
        loadJudges();
        setDefaultDateTime();
    });

    // Load cases via AJAX
    function loadCases() {
        fetch('{% url "court:case_list" %}')
            .then(response => response.text())
            .then(html => {
                // Parse HTML to extract case data
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const caseRows = doc.querySelectorAll('tbody tr[data-status]');
                
                const caseSelect = document.getElementById('case');
                caseRows.forEach(row => {
                    const caseNumber = row.querySelector('td:first-child strong').textContent;
                    const caseTitle = row.querySelector('td:nth-child(2) .fw-bold').textContent;
                    const caseId = row.querySelector('td:last-child a[href*="/cases/"]').href.split('/').slice(-2)[0];
                    
                    const option = document.createElement('option');
                    option.value = caseId;
                    option.textContent = `${caseNumber} - ${caseTitle}`;
                    caseSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading cases:', error);
            });
    }

    // Load judges via AJAX
    function loadJudges() {
        fetch('{% url "court:get_judges" %}')
            .then(response => response.json())
            .then(data => {
                const judgeSelect = document.getElementById('judge');
                data.judges.forEach(judge => {
                    const option = document.createElement('option');
                    option.value = judge.id;
                    option.textContent = judge.name;
                    judgeSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading judges:', error);
            });
    }

    // Set default date and time
    function setDefaultDateTime() {
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        document.getElementById('scheduled_date').value = tomorrow.toISOString().split('T')[0];
        document.getElementById('scheduled_time').value = '09:00';
    }
</script>
{% endblock %}
